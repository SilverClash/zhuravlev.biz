name: Lighthouse Badges

on:
  schedule:
    - cron: '0 6 * * 1' # Every Monday at 6:00 UTC
  workflow_dispatch:

concurrency:
  group: lighthouse-badges
  cancel-in-progress: false

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Lighthouse
        id: lighthouse
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: https://zhuravlev.biz
          uploadArtifacts: false

      - name: Generate circular badges
        run: |
          MANIFEST='${{ steps.lighthouse.outputs.manifest }}'
          PERF=$(echo "$MANIFEST" | jq -r '.[0].summary.performance * 100 | floor')
          A11Y=$(echo "$MANIFEST" | jq -r '.[0].summary.accessibility * 100 | floor')
          BP=$(echo "$MANIFEST" | jq -r '.[-1].summary["best-practices"] * 100 | floor')
          SEO=$(echo "$MANIFEST" | jq -r '.[0].summary.seo * 100 | floor')

          generate_badge() {
            local score=$1
            local name=$2
            local color="#f33" # red
            if [ "$score" -ge 90 ]; then color="#0c6"; # green
            elif [ "$score" -ge 50 ]; then color="#fa3"; fi # orange

            cat > "static/badges/lighthouse_${name}.svg" << EOF
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 60" width="60" height="60">
            <circle cx="30" cy="30" r="26" fill="none" stroke="${color}" stroke-width="4"/>
            <text x="30" y="36" text-anchor="middle" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="${color}">${score}</text>
          </svg>
          EOF
          }

          generate_badge "$PERF" "performance"
          generate_badge "$A11Y" "accessibility"
          generate_badge "$BP" "best-practices"
          generate_badge "$SEO" "seo"

      - name: Commit & push badges
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add static/badges/*.svg
          git diff --staged --quiet || git commit -m "chore: update lighthouse badges [skip ci]"
          git pull --rebase origin master
          git push origin master
